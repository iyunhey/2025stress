import streamlit as st
import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression # scikit-learn 라이브러리 사용

# 앱 제목 설정
st.title("스트레스 예측 및 개인 진단")
st.markdown("여기에 이름과 현재 상태에 대한 정보를 입력하시면, 신체 및 정신 스트레스 수준을 예측하고 맞춤형 진단 및 권고 사항을 제공해 드립니다.")

# CSV 파일 로드 (CP949 인코딩 명시)
# 'stress_sj.csv' 파일은 앱이 실행되는 디렉토리에 있어야 합니다.
try:
    df = pd.read_csv("stress_sj.csv", encoding="cp949") # 이 부분에 encoding="cp949" 추가
except FileNotFoundError:
    st.error("오류: 'stress_sj.csv' 파일을 찾을 수 없습니다. 파일이 앱과 같은 위치에 있는지 확인해주세요.")
    st.stop() # 파일이 없으면 앱 실행을 중지합니다.
except UnicodeDecodeError:
    st.error("오류: CSV 파일 인코딩이 CP949가 아닌 것 같습니다. 파일 인코딩을 확인해주세요.")
    st.stop()

# 컬럼 이름 정리: 앞뒤 공백 제거
df.columns = df.columns.str.strip()

# 예측에 사용할 입력 변수 리스트 (컬럼명이 CSV 파일과 정확히 일치해야 함)
features = [
    "이상심박수", "자율신경활성도 값", "자율신경 균형도",
    "피로도 값", "심장안정도 값", "혈관연령",
    "동맥혈관탄성도", "말초혈관탄성도"
]

# 실제 데이터프레임에 모든 특성 컬럼이 존재하는지 확인
for feature in features:
    if feature not in df.columns:
        st.error(f"오류: CSV 파일에 '{feature}' 컬럼이 없습니다. 컬럼 이름을 확인해주세요.")
        st.stop()

# 입력 변수와 타깃 변수 분리
X = df[features]
y_physical = df["신체스트레스 값"]
y_mental = df["정신스트레스 값"]

# 선형 회귀 모델 학습
# 모델 학습은 한 번만 수행되도록 앱 실행 시점에 진행합니다.
model_physical = LinearRegression()
model_mental = LinearRegression()
model_physical.fit(X, y_physical)
model_mental.fit(X, y_mental)

# --- 사용자 인터페이스 및 예측 ---

# 사용자 이름 입력
name = st.text_input("이름을 입력하세요 (예: 홍길동)")

# 입력값을 저장할 딕셔너리
input_vals = {}
if name:
    st.subheader(f"안녕하세요, {name}님! 다음 지표들을 입력해 주세요.")
    
    # 각 지표에 대한 슬라이더 생성
    for col in features:
        # 해당 컬럼의 최소/최대값 구하기
        min_val = float(df[col].min())
        max_val = float(df[col].max())
        
        # 슬라이더 생성 (기본값은 중간값으로 설정하여 사용자 입력 용이성 높임)
        # float 타입 슬라이더로 변경하여 더 정밀한 입력 가능
        input_vals[col] = st.slider(f"{col} (범위: {min_val:.2f} ~ {max_val:.2f})", min_val, max_val, (min_val + max_val) / 2)

    # 예측 수행 버튼
    if st.button("스트레스 예측하기"):
        # 입력된 값을 DataFrame 형태로 변환하여 모델에 전달
        X_new = pd.DataFrame([input_vals])
        
        # 예측값 계산
        pred_physical = model_physical.predict(X_new)[0]
        pred_mental = model_mental.predict(X_new)[0]

        # 예측값을 5단계 범주로 변환하는 함수
        def categorize(value, all_values, is_stress_value=True):
            # 스트레스 값은 높을수록 안 좋으므로, 퍼센타일 기준을 역순으로 적용
            # 즉, 낮은 20%가 '매우 좋음', 높은 20%가 '매우 안좋음'
            perc = np.percentile(all_values, [20, 40, 60, 80]) # 하위 20%, 40%, 60%, 80% 지점
            
            if is_stress_value: # 스트레스 값 (낮을수록 좋음)
                if value <= perc[0]:
                    return "매우 좋음"
                elif value <= perc[1]:
                    return "좋음"
                elif value <= perc[2]:
                    return "보통"
                elif value <= perc[3]:
                    return "안좋음"
                else:
                    return "매우 안좋음"
            else: # 다른 지표 (높을수록 좋음, 예를 들어 활성도나 안정도 등) - 현재 스트레스 값만 해당
                # 이 부분은 현재 신체/정신 스트레스 값에만 해당하므로 사용되지 않지만,
                # 혹시 다른 지표에 대한 단계 분류가 필요하다면 이 로직을 활용할 수 있습니다.
                if value >= perc[3]: # 상위 20%
                    return "매우 좋음"
                elif value >= perc[2]: # 상위 40%
                    return "좋음"
                elif value >= perc[1]: # 상위 60%
                    return "보통"
                elif value >= perc[0]: # 상위 80%
                    return "안좋음"
                else:
                    return "매우 안좋음"


        # 예측값을 범주로 변환 (신체/정신 스트레스 값은 낮을수록 좋음)
        phys_cat = categorize(pred_physical, y_physical, is_stress_value=True)
        ment_cat = categorize(pred_mental, y_mental, is_stress_value=True)

        st.markdown("---")
        st.write(f"### **{name}님의 스트레스 예측 결과**")
        st.write(f"- 신체 스트레스 예상 평가: **<span style='color: {'red' if phys_cat in ['매우 안좋음', '안좋음'] else 'green' if phys_cat in ['좋음', '매우 좋음'] else 'orange'}'>{phys_cat}</span>**", unsafe_allow_html=True)
        st.write(f"- 정신 스트레스 예상 평가: **<span style='color: {'red' if ment_cat in ['매우 안좋음', '안좋음'] else 'green' if ment_cat in ['좋음', '매우 좋음'] else 'orange'}'>{ment_cat}</span>**", unsafe_allow_html=True)
        st.markdown("---")

        st.subheader("개인 맞춤형 진단 및 권고 사항")
        st.info("⚠️ **주의**: 아래 진단과 권고 사항은 입력된 데이터를 기반으로 한 AI의 예측이며, 의학적 진단이나 전문적인 조언을 대체할 수 없습니다. 정확한 건강 상태 파악 및 관리를 위해서는 반드시 의료 전문가와 상담하시기 바랍니다.")

        # 신체 스트레스 진단서
        st.markdown("#### 신체 스트레스 진단")
        with st.expander(f"**신체 스트레스: {phys_cat}** 자세히 보기"):
            if phys_cat == "매우 안좋음":
                st.markdown("""
                **현재 상태**: 귀하의 신체 스트레스 수준은 현재 상당히 높은 것으로 예측됩니다. 이는 장기간의 피로 누적, 불균형한 생활 습관, 또는 특정 신체적 부담으로 인해 발생할 수 있습니다. 몸의 회복 능력이 저하되어 면역력 약화, 소화 불량, 근육 긴장 등 다양한 신체 증상으로 이어질 수 있습니다.
                
                **권고 사항**:
                * **충분한 휴식 및 수면**: 하루 7-8시간의 규칙적인 수면을 확보하고, 낮 시간에도 짧은 휴식 시간을 가져보세요.
                * **규칙적인 신체 활동**: 가벼운 걷기, 스트레칭, 요가 등 몸에 무리가 가지 않는 선에서 규칙적인 운동을 시작해 보세요. 신체 활동은 스트레스 호르몬을 감소시키고 기분 개선에 도움을 줍니다.
                * **균형 잡힌 식단**: 신선한 채소와 과일, 통곡물 위주의 균형 잡힌 식사를 통해 몸에 필요한 영양소를 충분히 공급해 주세요.
                * **이완 기법 활용**: 심호흡, 명상, 온욕 등을 통해 몸의 긴장을 이완시키는 시간을 가지세요.
                * **전문가 상담 고려**: 지속적으로 신체적 불편함이 느껴진다면, 의사 또는 전문가와의 상담을 통해 정확한 원인을 파악하고 적절한 치료 계획을 세우는 것이 중요합니다.
                """)
            elif phys_cat == "안좋음":
                st.markdown("""
                **현재 상태**: 귀하의 신체 스트레스 수준은 다소 높은 편으로 예측됩니다. 일상생활에서 알게 모르게 신체적 부담이 쌓이고 있을 가능성이 있습니다. 초기 단계의 신체적 불편함이나 피로감을 느낄 수 있습니다.
                
                **권고 사항**:
                * **휴식 시간 확보**: 바쁜 일상 속에서 의식적으로 짧은 휴식 시간을 확보하고, 주말에는 충분히 쉬어주세요.
                * **활동량 조절**: 신체 활동과 휴식의 균형을 맞추는 것이 중요합니다. 과도한 업무나 활동은 잠시 줄여보세요.
                * **스트레칭 및 가벼운 활동**: 틈틈이 스트레칭을 하거나 가벼운 산책을 통해 몸의 긴장을 풀어주세요.
                * **수분 섭취**: 충분한 수분 섭취는 신체 기능 유지에 필수적입니다.
                * **초기 증상 주시**: 신체적 불편함이 지속되거나 심화된다면 전문가의 도움을 받는 것을 고려해 보세요.
                """)
            elif phys_cat == "보통":
                st.markdown("""
                **현재 상태**: 귀하의 신체 스트레스 수준은 현재 보통 수준으로 예측됩니다. 이는 일상적인 수준의 스트레스에 잘 대처하고 계시거나, 아직 신체에 큰 부담이 누적되지 않았음을 의미합니다.
                
                **권고 사항**:
                * **현 상태 유지**: 현재의 건강한 생활 습관을 유지하는 것이 중요합니다.
                * **주기적인 건강 체크**: 정기적인 건강 검진을 통해 신체 상태를 점검하는 것이 좋습니다.
                * **스트레스 관리 습관**: 스트레스가 쌓일 때마다 자신만의 해소법(취미, 대화, 운동 등)을 활용하여 적절히 관리해 주세요.
                * **균형 잡힌 생활**: 충분한 수면, 규칙적인 운동, 건강한 식단을 꾸준히 실천해 주세요.
                """)
            elif phys_cat == "좋음":
                st.markdown("""
                **현재 상태**: 귀하의 신체 스트레스 수준은 낮은 편으로 예측됩니다. 이는 평소 건강 관리를 잘 하고 계시거나, 스트레스 요인에 대한 신체적 회복 탄력성이 높음을 나타냅니다. 몸이 활기차고 안정적인 상태일 가능성이 큽니다.
                
                **권고 사항**:
                * **건강한 습관 유지**: 현재의 긍정적인 생활 습관을 지속적으로 유지하는 것이 중요합니다.
                * **새로운 활동 도전**: 신체적 건강을 바탕으로 새로운 운동이나 취미 활동에 도전하여 삶의 활력을 높여보세요.
                * **주변에 긍정적인 영향**: 건강한 신체 상태를 유지하며 주변 사람들에게도 긍정적인 에너지를 전달해 주세요.
                """)
            else: # 매우 좋음
                st.markdown("""
                **현재 상태**: 귀하의 신체 스트레스 수준은 매우 낮은 최적의 상태로 예측됩니다! 이는 귀하의 몸이 스트레스에 매우 잘 대처하고 있으며, 뛰어난 회복 능력을 가지고 있음을 의미합니다. 활기차고 건강한 일상을 보내고 계실 것입니다.
                
                **권고 사항**:
                * **최적의 상태 유지**: 현재의 건강 관리 노력을 꾸준히 이어가는 것이 무엇보다 중요합니다.
                * **건강한 생활 전파**: 주변 사람들과 건강한 습관을 공유하며 긍정적인 영향을 미쳐 보세요.
                * **새로운 목표 설정**: 이 좋은 신체 컨디션을 바탕으로 새로운 건강 목표(마라톤, 등산 등)에 도전해 보는 것도 좋습니다.
                """)

        # 정신 스트레스 진단서
        st.markdown("#### 정신 스트레스 진단")
        with st.expander(f"**정신 스트레스: {ment_cat}** 자세히 보기"):
            if ment_cat == "매우 안좋음":
                st.markdown("""
                **현재 상태**: 귀하의 정신 스트레스 수준은 현재 매우 높은 것으로 예측됩니다. 이는 심한 불안감, 우울감, 무기력감, 집중력 저하, 수면 장애 등 다양한 정신적 어려움으로 나타날 수 있습니다. 일상생활에 지장을 초래할 만큼 큰 부담을 느끼고 계실 가능성이 높습니다.
                
                **권고 사항**:
                * **전문가 도움 요청**: 현재의 정신적 어려움을 혼자 감당하려 하지 마세요. 심리 상담사, 정신건강의학과 의사 등 전문적인 도움을 적극적으로 요청하는 것이 가장 중요합니다.
                * **감정 표현**: 신뢰할 수 있는 가족이나 친구에게 솔직하게 감정을 이야기하고 지지를 구하세요.
                * **휴식과 이완**: 과도한 자극을 피하고 충분한 휴식을 취하며, 명상, 요가, 가벼운 산책 등 마음을 안정시키는 활동을 시도해 보세요.
                * **스트레스 원인 파악**: 스트레스의 근본적인 원인을 파악하고, 가능한 부분부터 해결 방안을 모색해 보는 것이 좋습니다.
                * **긍정적인 환경 조성**: 마음이 편안해지는 공간을 만들거나, 즐거움을 주는 활동에 몰입해 보세요.
                """)
            elif ment_cat == "안좋음":
                st.markdown("""
                **현재 상태**: 귀하의 정신 스트레스 수준은 다소 높은 편으로 예측됩니다. 일상에서 스트레스를 느끼는 빈도가 높거나, 스트레스가 해소되지 않고 쌓이고 있을 수 있습니다. 사소한 일에도 예민해지거나 불안감을 느낄 수 있습니다.
                
                **권고 사항**:
                * **스트레스 해소 습관**: 자신에게 맞는 스트레스 해소법(취미, 음악 감상, 운동, 대화 등)을 찾아 꾸준히 실천하세요.
                * **긍정적 사고 연습**: 부정적인 생각에 갇히기보다 긍정적인 면을 찾아보고 감사하는 마음을 가지려 노력해 보세요.
                * **사회적 교류**: 친구나 가족과의 교류를 통해 정서적 지지를 얻고 고립감을 해소하세요.
                * **규칙적인 생활**: 충분한 수면과 균형 잡힌 식사는 정신 건강에도 긍정적인 영향을 미칩니다.
                * **필요시 전문가 상담**: 감정 기복이 심해지거나 우울감이 지속된다면 전문가의 도움을 주저하지 마세요.
                """)
            elif ment_cat == "보통":
                st.markdown("""
                **현재 상태**: 귀하의 정신 스트레스 수준은 현재 보통 수준으로 예측됩니다. 이는 일상적인 스트레스에 잘 대처하고 계시거나, 아직 정신 건강에 큰 부담이 누적되지 않았음을 의미합니다.
                
                **권고 사항**:
                * **마음 건강 유지**: 현재의 건강한 정신 상태를 유지하는 것이 중요합니다.
                * **정신적 여유 찾기**: 바쁜 일상 속에서도 명상, 독서, 취미 생활 등 자신을 위한 시간을 확보하여 정신적 여유를 가지세요.
                * **스트레스 신호 인지**: 스트레스가 증가할 때 나타나는 자신만의 신호를 미리 알아차리고, 초기 단계에서 관리하는 습관을 들이세요.
                * **긍정적인 관계 유지**: 주변 사람들과의 긍정적인 관계를 유지하고, 필요할 때 도움을 주고받는 것에 주저하지 마세요.
                """)
            elif ment_cat == "좋음":
                st.markdown("""
                **현재 상태**: 귀하의 정신 스트레스 수준은 낮은 편으로 예측됩니다. 이는 평소 긍정적인 사고방식을 가지고 스트레스에 잘 대처하고 계시거나, 심리적으로 매우 안정적인 상태임을 나타냅니다. 감정적으로 평온하고 활기찬 일상을 보내고 계실 것입니다.
                
                **권고 사항**:
                * **강점 유지**: 현재의 강점(긍정적 사고, 회복 탄력성)을 계속 유지하고 발전시키는 것이 중요합니다.
                * **새로운 도전**: 정신적 건강을 바탕으로 새로운 학습이나 창의적인 활동에 도전하여 삶의 만족도를 높여보세요.
                * **주변에 긍정적인 영향**: 건강한 정신 상태를 유지하며 주변 사람들에게도 긍정적인 에너지를 전달해 주세요.
                """)
            else: # 매우 좋음
                st.markdown("""
                **현재 상태**: 귀하의 정신 스트레스 수준은 매우 낮은 최적의 상태로 예측됩니다! 이는 귀하가 스트레스에 매우 잘 대처하고 있으며, 뛰어난 심리적 안정성과 회복 탄력성을 가지고 있음을 의미합니다. 평화롭고 만족스러운 일상을 경험하고 계실 것입니다.
                
                **권고 사항**:
                * **최적의 상태 유지**: 현재의 정신 건강 관리 노력을 꾸준히 이어가는 것이 무엇보다 중요합니다.
                * **자기 돌봄 지속**: 자신을 위한 시간을 꾸준히 갖고, 스트레스에 대한 자신만의 대처 방식을 더욱 발전시키세요.
                * **나눔과 기여**: 정신적 여유를 바탕으로 타인을 돕거나 사회에 기여하는 활동을 통해 더 큰 만족감을 느껴보세요.
                """)
        st.markdown("---")

